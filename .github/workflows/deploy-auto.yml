# .github/workflows/deploy-auto.yml
name: Build and Deploy to Auto Server
on:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - "*"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check commit message for COMMIT flag
        id: check-commit
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"[COMMIT]"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "커밋 메시지에 [COMMIT] 플래그가 감지되어 작업을 중단합니다."
            exit 0
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "계속 진행합니다."
          fi

      - name: Set variables
        id: vars
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          if [[ "$BRANCH_NAME" == "main" ]]; then
            DEPLOY_BRANCH="main"
          else
            DEPLOY_BRANCH="dev"
          fi
          echo "repo_name=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "deploy_branch=$DEPLOY_BRANCH" >> $GITHUB_OUTPUT
          echo "docker_image=${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:$DEPLOY_BRANCH" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        if: steps.check-commit.outputs.skip == 'false'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Frontend image
        if: steps.check-commit.outputs.skip == 'false'
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: front.Dockerfile
          push: true
          tags: ${{ steps.vars.outputs.docker_image }}-front
          cache-from: type=registry,ref=${{ steps.vars.outputs.docker_image }}-front
          platforms: linux/amd64

      - name: Build and push Backend image
        if: steps.check-commit.outputs.skip == 'false'
        id: build-backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: back.Dockerfile
          push: true
          tags: ${{ steps.vars.outputs.docker_image }}-back
          cache-from: type=registry,ref=${{ steps.vars.outputs.docker_image }}-back
          platforms: linux/amd64

      - name: Build and push Automation image
        if: steps.check-commit.outputs.skip == 'false'
        id: build-automation
        uses: docker/build-push-action@v5
        with:
          context: .
          file: automation.Dockerfile
          push: true
          tags: ${{ steps.vars.outputs.docker_image }}-automation
          cache-from: type=registry,ref=${{ steps.vars.outputs.docker_image }}-automation
          platforms: linux/amd64

      - name: Check build results
        if: steps.check-commit.outputs.skip == 'false'
        run: |
          echo "=== 빌드 결과 확인 ==="
          if [[ "${{ steps.build-frontend.outcome }}" != "success" ]]; then
            echo "❌ Frontend 이미지 빌드 실패"
            exit 1
          fi
          if [[ "${{ steps.build-backend.outcome }}" != "success" ]]; then
            echo "❌ Backend 이미지 빌드 실패"
            exit 1
          fi
          if [[ "${{ steps.build-automation.outcome }}" != "success" ]]; then
            echo "❌ Automation 이미지 빌드 실패"
            exit 1
          fi
          echo "✅ 모든 이미지 빌드 성공"

      - name: Deploy to Auto Server
        if: steps.check-commit.outputs.skip == 'false' && steps.build-frontend.outcome == 'success' && steps.build-backend.outcome == 'success' && steps.build-automation.outcome == 'success'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 변수 설정
            REPO_NAME="${{ steps.vars.outputs.repo_name }}"
            BRANCH_NAME="${{ steps.vars.outputs.branch_name }}"
            DEPLOY_BRANCH="${{ steps.vars.outputs.deploy_branch }}"
            DOCKER_IMAGE="${{ steps.vars.outputs.docker_image }}"
            DEPLOY_PATH="/home/kth88/services/$REPO_NAME/$DEPLOY_BRANCH"
            
            echo "=== 배포 시작 ==="
            echo "Repository: $REPO_NAME"
            echo "Branch: $BRANCH_NAME"
            echo "Deploy Branch: $DEPLOY_BRANCH"
            echo "Deploy Path: $DEPLOY_PATH"
            echo "Docker Image: $DOCKER_IMAGE"

            # 배포 디렉토리 생성
            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            # 기존 컨테이너 정리
            echo "=== 기존 컨테이너 정리 ==="
            docker-compose down --remove-orphans -v 2>/dev/null || true
            docker rmi "$DOCKER_IMAGE" 2>/dev/null || true

            # 필요한 파일들만 복사
            echo "=== 필요한 파일들 복사 ==="
            # docker-compose.yml, start.sh, genkey.sh 파일들을 현재 디렉토리로 복사
            # 이 파일들은 GitHub Actions에서 직접 전송됨

            # logs와 data 폴더 생성
            mkdir -p logs data

            # 환경 변수 설정
            PROJECT_DIR="$DEPLOY_PATH"
            DOCKER_IMAGE="$DOCKER_IMAGE"
            if [[ "$DEPLOY_BRANCH" == "main" ]]; then
              DOMAIN="hanyang.newme.dev"
            else
              DOMAIN="dev-hanyang.newme.dev"
            fi
            CONTAINER_NAME="hanyangauto-$DEPLOY_BRANCH"
            if [[ "$DEPLOY_BRANCH" == "main" ]]; then
              PORT="8000"
            else
              PORT="8001"
            fi
            COMPOSE_PROJECT_NAME="hanyangauto-$DEPLOY_BRANCH"
            

            echo "=== 환경 변수 설정 완료 ==="
            echo "PROJECT_DIR: $PROJECT_DIR"
            echo "DOCKER_IMAGE: $DOCKER_IMAGE"
            echo "DOMAIN: $DOMAIN"
            echo "CONTAINER_NAME: $CONTAINER_NAME"
            echo "PORT: $PORT"
            echo "COMPOSE_PROJECT_NAME: $COMPOSE_PROJECT_NAME"


      - name: Upload required files
        if: steps.check-commit.outputs.skip == 'false' && steps.build-frontend.outcome == 'success' && steps.build-backend.outcome == 'success' && steps.build-automation.outcome == 'success'
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: "/home/kth88/services/${{ steps.vars.outputs.repo_name }}/${{ steps.vars.outputs.deploy_branch }}/"

      - name: Load Docker image and start services
        if: steps.check-commit.outputs.skip == 'false' && steps.build-frontend.outcome == 'success' && steps.build-backend.outcome == 'success' && steps.build-automation.outcome == 'success'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 변수 설정
            REPO_NAME="${{ steps.vars.outputs.repo_name }}"
            BRANCH_NAME="${{ steps.vars.outputs.branch_name }}"
            DEPLOY_BRANCH="${{ steps.vars.outputs.deploy_branch }}"
            DOCKER_IMAGE="${{ steps.vars.outputs.docker_image }}"
            DEPLOY_PATH="/home/kth88/services/$REPO_NAME/$DEPLOY_BRANCH"
            
            cd "$DEPLOY_PATH"

            # Docker Hub에서 이미지들 pull
            echo "=== Docker Hub에서 이미지들 pull ==="
            echo "Frontend 이미지 pull 시도: $DOCKER_IMAGE-front"
            if ! docker pull "$DOCKER_IMAGE-front"; then
              echo "Frontend 이미지 pull 실패: $DOCKER_IMAGE-front"
              echo "이미지가 존재하지 않거나 빌드에 실패했을 수 있습니다."
              exit 1
            fi
            echo "Backend 이미지 pull 시도: $DOCKER_IMAGE-back"
            if ! docker pull "$DOCKER_IMAGE-back"; then
              echo "Backend 이미지 pull 실패: $DOCKER_IMAGE-back"
              exit 1
            fi
            echo "Automation 이미지 pull 시도: $DOCKER_IMAGE-automation"
            if ! docker pull "$DOCKER_IMAGE-automation"; then
              echo "Automation 이미지 pull 실패: $DOCKER_IMAGE-automation"
              exit 1
            fi

            # 이미지 존재 확인
            echo "=== 이미지 존재 확인 ==="
            docker images | grep "$DOCKER_IMAGE-front" || { echo "Frontend 이미지를 찾을 수 없습니다: $DOCKER_IMAGE-front"; exit 1; }
            docker images | grep "$DOCKER_IMAGE-back" || { echo "Backend 이미지를 찾을 수 없습니다: $DOCKER_IMAGE-back"; exit 1; }
            docker images | grep "$DOCKER_IMAGE-automation" || { echo "Automation 이미지를 찾을 수 없습니다: $DOCKER_IMAGE-automation"; exit 1; }
            echo "모든 이미지가 성공적으로 로드되었습니다."

            # .env 파일 생성
            echo "=== .env 파일 생성 ==="
            echo "DOCKER_IMAGE=${DOCKER_IMAGE}" > .env
            echo "DOMAIN=${DOMAIN}" >> .env
            echo "CONTAINER_NAME=${CONTAINER_NAME}" >> .env
            echo "PORT=${PORT}" >> .env
            echo "DB_ENCRYPTION_KEY_B64=$(base64 < ./data/암호화\ 키.key)" >> .env
            echo "COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}" >> .env

            # Docker Compose로 서비스 재시작
            echo "=== Docker Compose로 서비스 재시작 ==="
            
            # (안전장치) 동일 이름의 컨테이너가 남아있으면 강제 제거
            EXISTING=$(docker ps -aq -f name="^/${CONTAINER_NAME}" || true)
            if [ -n "$EXISTING" ]; then
              echo "기존 컨테이너들을 제거합니다: $EXISTING"
              docker rm -f $EXISTING || true
            fi

            # 외부 네트워크가 없다면 생성 (traefik-net)
            docker network inspect traefik-net >/dev/null 2>&1 || docker network create traefik-net || true

            # Docker Compose 실행
            docker-compose -p "${COMPOSE_PROJECT_NAME}" down --remove-orphans -v || true
            docker-compose -p "${COMPOSE_PROJECT_NAME}" up -d --no-build

            echo "=== 배포 완료 ==="
            echo "서비스가 성공적으로 배포되었습니다."
            if [[ "$DEPLOY_BRANCH" == "main" ]]; then
              echo "도메인: hanyang.newme.dev"
            else
              echo "도메인: dev-hanyang.newme.dev"
            fi

            # start.sh 파일 생성 (백업용)
            echo "=== start.sh 파일 생성 (백업용) ==="
            echo "#!/bin/bash" > start.sh
            echo "# 백업용 start.sh - 워크플로우에서 자동 생성됨" >> start.sh
            echo "echo \"이 파일은 워크플로우에서 자동으로 생성된 백업용 파일입니다.\"" >> start.sh
            echo "echo \"실제 배포는 GitHub Actions 워크플로우에서 처리됩니다.\"" >> start.sh
            chmod +x start.sh
